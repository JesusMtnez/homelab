---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  cluster: fluffy
  ns: '{{.ns | default "default"}}'
  app: '{{ .app }}'

tasks:
  preview:
    desc: Preview
    requires:
      vars: ["app"]
    summary: |
      Args
        namespace: namespace of the application (default: default)
        app: application to preview
    cmds:
      - kubectl kustomize --enable-helm {{.KUBERNETES_DIR}}/{{.cluster}}/{{.ns}}/{{.app}}
      - defer: { task: cleanup }
    preconditions:
      - { msg: "Missing namespace", sh: "test -d {{.KUBERNETES_DIR}}/{{.cluster}}/{{.ns}}" }
      - { msg: "Missing application", sh: "test -d {{.KUBERNETES_DIR}}/{{.cluster}}/{{.ns}}/{{.app}}" }

  apply:
    desc: Apply
    requires:
      vars: ["app"]
    summary: |
      Args
        namespace: namespace of the application (default: default)
        app: application
    cmds:
      # - sops --decrypt {{.KUBERNETES_DIR}}/{{.cluster}}/{{.ns}}/{{.app}}/secret.sops.yml | kubectl apply -f -
      - kubectl kustomize --enable-helm {{.KUBERNETES_DIR}}/{{.cluster}}/{{.ns}}/{{.app}} | kubectl apply -f -
      - defer: { task: cleanup }
    preconditions:
      - { msg: "Missing namespace", sh: "test -d {{.KUBERNETES_DIR}}/{{.cluster}}/{{.ns}}" }
      - { msg: "Missing application", sh: "test -d {{.KUBERNETES_DIR}}/{{.cluster}}/{{.ns}}/{{.app}}" }

  cleanup:
    internal: true
    silent: true
    cmds:
      - rm -rf {{.KUBERNETES_DIR}}/{{.cluster}}/{{.ns}}/{{.app}}/charts
